# CORS Fix - October 13, 2025

## Issue
Frontend was experiencing CORS errors when trying to load thumbnail images from the backend API. The error was `net::ERR_BLOCKED_BY_RESPONSE.NotSameOrigin 200 (OK)`, which indicated the server was returning 200 OK but the browser was blocking the response.

## Root Cause
Two separate issues were causing the CORS blockage:

1. **Missing explicit CORS headers on file streaming responses**: The media routes were using `createReadStream().pipe(res)` to stream files, which bypassed the global CORS middleware. While the CORS middleware in `index.ts` was configured correctly, it wasn't being applied to streamed responses.

2. **Helmet.js `Cross-Origin-Resource-Policy` header**: Helmet.js was adding a `Cross-Origin-Resource-Policy: same-origin` header by default, which explicitly blocked cross-origin access to resources even when CORS headers were present.

## Solution

### 1. Added Explicit CORS Headers to Media Routes
**File**: `src/backend/src/routes/media.ts`

Added explicit CORS headers before streaming files in all three media routes:
- Lines 180-182: Multi-level subdirectory route (`/:slug/...`)
- Lines 322-324: Root-level file route (`/:slug/:filename`)
- Lines 438-440: Gallery route (`/:slug/gallery/:filename`)

```typescript
// Set CORS headers explicitly for file streaming
res.setHeader('Access-Control-Allow-Origin', req.headers.origin || '*');
res.setHeader('Access-Control-Allow-Credentials', 'true');
```

### 2. Disabled Helmet.js Cross-Origin-Resource-Policy
**File**: `src/backend/src/index.ts`

Modified Helmet configuration to disable the conflicting security header:

```typescript
app.use(helmet({
  contentSecurityPolicy: {
    directives: {
      defaultSrc: ["'self'"],
      styleSrc: ["'self'", "'unsafe-inline'"],
      scriptSrc: ["'self'"],
      imgSrc: ["'self'", "data:", "https:"],
      connectSrc: ["'self'", "ws:", "wss:"],
    },
  },
  // Disable Cross-Origin-Resource-Policy to allow images to be loaded from localhost:3000
  crossOriginResourcePolicy: false,
}));
```

## Verification
After the fix, thumbnail requests now include proper CORS headers:
- ✅ `Access-Control-Allow-Origin: http://localhost:3000`
- ✅ `Access-Control-Allow-Credentials: true`
- ✅ **NO** `Cross-Origin-Resource-Policy` header (previously was blocking)

## Files Modified
- `src/backend/src/routes/media.ts` - Added explicit CORS headers to all media serving routes
- `src/backend/src/index.ts` - Disabled Helmet.js Cross-Origin-Resource-Policy header

## Context
This issue arose after a git merge that corrupted several configuration files and database entries. The CORS configuration had been working correctly before the merge but needed these additional fixes to handle file streaming properly.

## Lessons Learned
- File streaming with `createReadStream().pipe(res)` can bypass global middleware
- Helmet.js security headers can override CORS configuration
- Always verify security middleware configuration when implementing CORS
- The `Cross-Origin-Resource-Policy` header is separate from CORS and needs explicit configuration

---
**Fixed by**: Viktor (Backend API Specialist)
**Date**: October 13, 2025
**Status**: ✅ Resolved
